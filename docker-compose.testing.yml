# PestWP Docker Compose Template for Browser Testing
#
# This template provides a WordPress environment for browser tests.
# Copy this file to your project as `docker-compose.testing.yml`
#
# Usage:
#   docker-compose -f docker-compose.testing.yml up -d
#   vendor/bin/pest-setup-browser --url http://localhost:8080 --pass password
#   vendor/bin/pest --browser tests/Browser/
#
# For CI/CD, see .github/workflows/browser-tests.yml

version: '3.8'

services:
  wordpress:
    image: wordpress:latest
    container_name: pestwp-wordpress
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
      WORDPRESS_DB_NAME: wordpress
      WORDPRESS_DEBUG: 1
      # Auto-install WordPress with these credentials
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_DEBUG', true);
        define('WP_DEBUG_LOG', true);
        define('WP_DEBUG_DISPLAY', false);
        define('SCRIPT_DEBUG', true);
        define('AUTOMATIC_UPDATER_DISABLED', true);
        define('WP_AUTO_UPDATE_CORE', false);
    volumes:
      # Mount your plugin for testing
      - ./:/var/www/html/wp-content/plugins/my-plugin:ro
      # Persist WordPress data (optional, remove for fresh installs)
      - wordpress_data:/var/www/html
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/wp-admin/install.php"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  db:
    image: mysql:8.0
    container_name: pestwp-mysql
    environment:
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # WordPress CLI for setup
  wpcli:
    image: wordpress:cli
    container_name: pestwp-cli
    depends_on:
      wordpress:
        condition: service_healthy
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
      WORDPRESS_DB_NAME: wordpress
    volumes:
      - wordpress_data:/var/www/html
    entrypoint: >
      sh -c '
        echo "Waiting for WordPress...";
        sleep 5;
        if ! wp core is-installed --allow-root 2>/dev/null; then
          echo "Installing WordPress...";
          wp core install \
            --url=http://localhost:8080 \
            --title="PestWP Test Site" \
            --admin_user=admin \
            --admin_password=password \
            --admin_email=admin@example.org \
            --skip-email \
            --allow-root;
          echo "WordPress installed!";
        else
          echo "WordPress already installed.";
        fi;
        echo "WordPress is ready at http://localhost:8080";
        echo "Admin: admin / password";
      '

volumes:
  wordpress_data:
  db_data:

# Network configuration (optional)
networks:
  default:
    name: pestwp-network
